
/*
 * 
 * To build:
 * 	zcc +zx -m -create-app .\isometricos_tests.c .\sprites_mask_tests.c .\precalculated_shift_tables.asm
 * 
 */

#pragma output CRT_ORG_CODE          = 0x8000

#include "keyboard.h"
#include "isometric_system_tests.h"

/*******************************************************************************************************/

// imagen binaria y mascara en bytes alternos
byte graph_bin_def_block[] =
	{
		SPRITE_GRAPHIC_STATE_FLIPPED_RIGHT, // graphic state mask
		0x00, 0xFF, 0x00, 0xFE, 0x00, 0x7F, 0x00, 0xFF,
		0x00, 0xFF, 0x01, 0xF8, 0x80, 0x1F, 0x00, 0xFF,
		0x00, 0xFF, 0x07, 0xE0, 0xE0, 0x07, 0x00, 0xFF,
		0x00, 0xFF, 0x1F, 0x80, 0xF8, 0x01, 0x00, 0xFF,
		0x00, 0xFE, 0x7F, 0x00, 0xFE, 0x00, 0x00, 0x7F,
		0x01, 0xF8, 0xFF, 0x00, 0xFF, 0x00, 0x80, 0x1F,
		0x07, 0xE0, 0xFF, 0x00, 0xFF, 0x00, 0xE0, 0x07,
		0x1F, 0x80, 0xFF, 0x00, 0xFF, 0x00, 0xF8, 0x01,
		0x7F, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFE, 0x00,
		0x5F, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFA, 0x00,
		0x67, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xE4, 0x00,
		0x79, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0x8A, 0x00,
		0x7E, 0x00, 0x7F, 0x00, 0xFE, 0x00, 0x54, 0x00,
		0x7F, 0x00, 0x9F, 0x00, 0xF8, 0x00, 0xAA, 0x00,
		0x7F, 0x00, 0xE7, 0x00, 0xE5, 0x00, 0x54, 0x00,
		0x7F, 0x00, 0xF9, 0x00, 0x8A, 0x00, 0xAA, 0x00,
		0x7F, 0x00, 0xFE, 0x00, 0x55, 0x00, 0x54, 0x00,
		0x7F, 0x00, 0xFE, 0x00, 0xAA, 0x00, 0xAA, 0x00,
		0x7F, 0x00, 0xFE, 0x00, 0x55, 0x00, 0x54, 0x00,
		0x7F, 0x00, 0xFE, 0x00, 0xAA, 0x00, 0xAA, 0x00,
		0x1F, 0x80, 0xFE, 0x00, 0x55, 0x00, 0x50, 0x01,
		0x07, 0xE0, 0xFE, 0x00, 0xAA, 0x00, 0x80, 0x07,
		0x01, 0xF8, 0xFE, 0x00, 0x55, 0x00, 0x00, 0x1F,
		0x00, 0xFE, 0x7E, 0x00, 0xAA, 0x00, 0x00, 0x7F,
		0x00, 0xFF, 0x1E, 0x80, 0x50, 0x01, 0x00, 0xFF,
		0x00, 0xFF, 0x06, 0xE0, 0xA0, 0x07, 0x00, 0xFF,
		0x00, 0xFF, 0x01, 0xF8, 0x80, 0x1F, 0x00, 0xFF,
		0x00, 0xFF, 0x00, 0xFE, 0x00, 0x7F, 0x00, 0xFF
	};

byte graph_bin_def_ghost[] =
	{
		// frame 0-0. Direccion sur-oeste
		SPRITE_GRAPHIC_STATE_FLIPPED_LEFT, // graphic state mask
		0x00, 0xFF, 0x00, 0xC3, 0x00, 0xFF,
		0x00, 0xFF, 0x3C, 0x00, 0x00, 0xFF,
		0x00, 0xFE, 0xFF, 0x00, 0x00, 0x7F,
		0x01, 0xFC, 0xFF, 0x00, 0x80, 0x3F,
		0x01, 0xFC, 0xFF, 0x00, 0xC0, 0x1F,
		0x03, 0xF8, 0x3F, 0x00, 0xE0, 0x0F,
		0x02, 0xF8, 0xC7, 0x00, 0xE0, 0x0F,
		0x06, 0xF0, 0x9B, 0x00, 0xF0, 0x07,
		0x07, 0xF0, 0x0B, 0x00, 0xF0, 0x07,
		0x0F, 0xE0, 0xE7, 0x00, 0xF8, 0x03,
		0x1F, 0xC0, 0xFF, 0x00, 0xFC, 0x01,
		0x3F, 0x80, 0xFF, 0x00, 0xFC, 0x01,
		0x7F, 0x00, 0xFF, 0x00, 0xFE, 0x00,
		0x7F, 0x00, 0xFF, 0x00, 0xFE, 0x00,
		0x03, 0x80, 0xFF, 0x00, 0x66, 0x00,
		0x01, 0xFC, 0xFE, 0x00, 0x00, 0x19,
		0x01, 0xFC, 0xFF, 0x00, 0x00, 0x7F,
		0x00, 0xFE, 0x3F, 0x00, 0x00, 0x7F,
		0x00, 0xFF, 0x1E, 0xC0, 0x00, 0xFF,
		0x00, 0xFF, 0x00, 0xE1, 0x00, 0xFF,
		// frame 0-1. Direccion sur-oeste
		SPRITE_GRAPHIC_STATE_FLIPPED_LEFT, // graphic state mask
		0x00, 0xFF, 0x00, 0xC3, 0x00, 0xFF,
		0x00, 0xFE, 0x3C, 0x00, 0x00, 0x7F,
		0x01, 0xFC, 0xFF, 0x00, 0x80, 0x1F,
		0x03, 0xF8, 0xFF, 0x00, 0xE0, 0x0F,
		0x07, 0xF0, 0x3F, 0x00, 0xF0, 0x07,
		0x06, 0xF0, 0xC7, 0x00, 0xF0, 0x07,
		0x06, 0xF0, 0x9B, 0x00, 0xF0, 0x07,
		0x0F, 0xE0, 0x0B, 0x00, 0xF8, 0x03,
		0x1F, 0xC0, 0xE7, 0x00, 0xF8, 0x03,
		0x3F, 0x80, 0xFF, 0x00, 0xFC, 0x01,
		0x7F, 0x00, 0xFF, 0x00, 0xFE, 0x00,
		0x7F, 0x00, 0xFF, 0x00, 0xFE, 0x00,
		0x07, 0x80, 0xFF, 0x00, 0xFE, 0x00,
		0x07, 0xF0, 0xFF, 0x00, 0xF8, 0x01,
		0x0F, 0xE0, 0xFF, 0x00, 0xF8, 0x03,
		0x07, 0xF0, 0x3F, 0x00, 0x38, 0x03,
		0x00, 0xF8, 0x1E, 0xC0, 0x00, 0xC7,
		0x00, 0xFF, 0x1C, 0xC1, 0x00, 0xFF,
		0x00, 0xFF, 0x00, 0xE3, 0x00, 0xFF,
		0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF,
		// frame 1-0. Direccion nor-este
		SPRITE_GRAPHIC_STATE_FLIPPED_RIGHT, // graphic state mask
		0x00, 0xFF, 0x00, 0xC3, 0x00, 0xFF,
		0x00, 0xFF, 0x3C, 0x00, 0x00, 0xFF,
		0x00, 0xFE, 0xFF, 0x00, 0x00, 0x7F,
		0x01, 0xFC, 0xFF, 0x00, 0x80, 0x3F,
		0x01, 0xFC, 0xFF, 0x00, 0xC0, 0x1F,
		0x03, 0xF8, 0xFF, 0x00, 0x20, 0x0F,
		0x03, 0xF8, 0xFF, 0x00, 0x20, 0x0F,
		0x07, 0xF0, 0xFF, 0x00, 0x50, 0x07,
		0x07, 0xF0, 0xFF, 0x00, 0x98, 0x03,
		0x0F, 0xE0, 0xFF, 0x00, 0xF8, 0x03,
		0x1F, 0xC0, 0xFF, 0x00, 0xFC, 0x01,
		0x3F, 0x80, 0xFF, 0x00, 0xFE, 0x00,
		0x7F, 0x00, 0xFF, 0x00, 0xFE, 0x00,
		0x7F, 0x00, 0xFF, 0x00, 0xFC, 0x01,
		0x3F, 0x80, 0xFF, 0x00, 0xF0, 0x03,
		0x0F, 0xC0, 0xFF, 0x00, 0xF0, 0x07,
		0x07, 0xF0, 0xFF, 0x00, 0xF0, 0x07,
		0x03, 0xF8, 0x1F, 0x00, 0x00, 0x0F,
		0x00, 0xFC, 0x06, 0xE0, 0x00, 0xFF,
		0x00, 0xFF, 0x00, 0xF9, 0x00, 0xFF,
		// frame 1-1. Direccion nor-este
		SPRITE_GRAPHIC_STATE_FLIPPED_RIGHT, // graphic state mask
		0x00, 0xFF, 0x00, 0xC3, 0x00, 0xFF,
		0x00, 0xFF, 0x3C, 0x00, 0x00, 0xFF,
		0x00, 0xFE, 0xFF, 0x00, 0x00, 0x7F,
		0x01, 0xFC, 0xFF, 0x00, 0x80, 0x3F,
		0x01, 0xFC, 0xFF, 0x00, 0xC0, 0x1F,
		0x03, 0xF8, 0xFF, 0x00, 0x20, 0x0F,
		0x03, 0xF8, 0xFF, 0x00, 0x20, 0x0F,
		0x07, 0xF0, 0xFF, 0x00, 0x50, 0x07,
		0x07, 0xF0, 0xFF, 0x00, 0x98, 0x03,
		0x0F, 0xE0, 0xFF, 0x00, 0xF8, 0x03,
		0x1F, 0xC0, 0xFF, 0x00, 0xFC, 0x01,
		0x3F, 0x80, 0xFF, 0x00, 0xFE, 0x00,
		0x7F, 0x00, 0xFF, 0x00, 0xFE, 0x00,
		0x3F, 0x80, 0xFF, 0x00, 0xFC, 0x01,
		0x0F, 0xC0, 0xFF, 0x00, 0xF8, 0x03,
		0x0F, 0xE0, 0x3F, 0x00, 0xF8, 0x03,
		0x1E, 0xC0, 0x3F, 0x80, 0x30, 0x07,
		0x00, 0xE1, 0x3F, 0x80, 0x00, 0x0F,
		0x00, 0xFF, 0x1E, 0xC0, 0x00, 0xFF,
		0x00, 0xFF, 0x00, 0xE1, 0x00, 0xFF
	};

t_sprite_graphic_def spr_graph_def_block = 
	{	
		4, 28, // 4x character cells in width, 28 scan lines in height
		-15, -13,
		224 + 1,
		224 + 1,
		graph_bin_def_block
	};

t_sprite_graphic_def spr_graph_def_ghost = 
	{	
		3, 20, // 4x character cells in width, 28 scan lines in height
		-11, -10,
		120 + 1,
		4*(120 + 1),
		graph_bin_def_ghost
	};

t_isometric_obj_def isometric_def_block =
	{
		{ 8, 8, 6 },
		&spr_graph_def_block
	};

t_isometric_obj_def isometric_def_ghost =
	{
		{ 6, 6, 5 },
		&spr_graph_def_ghost
	};

t_b_vec3d pos_block_0 = { 30, 30, 50 };
t_b_vec3d pos_block_1 = { 40, 50, 60 };
t_b_vec3d pos_block_2 = { 40, 50, 20 };
t_b_vec3d pos_ghost   = { 30, 30, 20 };

/*******************************************************************************************************/

byte nframes;
byte ghost_last_orientation = ISOMETRIC_ORIENTATION_S | ISOMETRIC_ORIENTATION_W;

extern byte predivisor_gravity;

void behavior_controller_player(t_isometric_obj *p_isometric_obj_player)
{
	if(keyboard_is_key_pressed_1()) 
	{
		if(p_isometric_obj_player->physics.flags & PHYS_BOX3D_FLAG_TOUCH_D)
		{
			p_isometric_obj_player->physics.speed_y = p_isometric_obj_player->physics.p_phys_obj_touching_d->speed_y - 1;
		}

		if(ghost_last_orientation != (ISOMETRIC_ORIENTATION_N | ISOMETRIC_ORIENTATION_W))
		{
			ghost_last_orientation = ISOMETRIC_ORIENTATION_N | ISOMETRIC_ORIENTATION_W;
			sprite_set_frames_subset(&(p_isometric_obj_player->sprite), &spr_graph_def_ghost, spr_graph_def_ghost.frame_size + spr_graph_def_ghost.frame_size, spr_graph_def_ghost.total_frames_size);
			p_isometric_obj_player->sprite.required_graphic_state = (p_isometric_obj_player->sprite.required_graphic_state & (~SPRITE_GRAPHIC_STATE_MASK_FLIPPED_H)) | SPRITE_GRAPHIC_STATE_FLIPPED_LEFT;
		}
		else
		{
			if(!(nframes & 7)) sprite_next_frame(&(p_isometric_obj_player->sprite));
		}
	}

	if(keyboard_is_key_pressed_q())
	{
		if(p_isometric_obj_player->physics.flags & PHYS_BOX3D_FLAG_TOUCH_D)
		{
			p_isometric_obj_player->physics.speed_y = p_isometric_obj_player->physics.p_phys_obj_touching_d->speed_y + 1;
		}

		if(ghost_last_orientation != (ISOMETRIC_ORIENTATION_S | ISOMETRIC_ORIENTATION_E))
		{
			ghost_last_orientation = ISOMETRIC_ORIENTATION_S | ISOMETRIC_ORIENTATION_E;
			sprite_set_frames_subset(&(p_isometric_obj_player->sprite), &spr_graph_def_ghost, 0, spr_graph_def_ghost.frame_size + spr_graph_def_ghost.frame_size);
			p_isometric_obj_player->sprite.required_graphic_state = (p_isometric_obj_player->sprite.required_graphic_state & (~SPRITE_GRAPHIC_STATE_MASK_FLIPPED_H)) | SPRITE_GRAPHIC_STATE_FLIPPED_RIGHT;
		}
		else
		{
			if(!(nframes & 7)) sprite_next_frame(&(p_isometric_obj_player->sprite));
		}
	}

	if(keyboard_is_key_pressed_3())
	{
		if(p_isometric_obj_player->physics.flags & PHYS_BOX3D_FLAG_TOUCH_D)
		{
			p_isometric_obj_player->physics.speed_x = p_isometric_obj_player->physics.p_phys_obj_touching_d->speed_x - 1;
		}

		if(ghost_last_orientation != (ISOMETRIC_ORIENTATION_N | ISOMETRIC_ORIENTATION_E))
		{
			ghost_last_orientation = ISOMETRIC_ORIENTATION_N | ISOMETRIC_ORIENTATION_E;
			sprite_set_frames_subset(&(p_isometric_obj_player->sprite), &spr_graph_def_ghost, spr_graph_def_ghost.frame_size + spr_graph_def_ghost.frame_size, spr_graph_def_ghost.total_frames_size);
			p_isometric_obj_player->sprite.required_graphic_state = (p_isometric_obj_player->sprite.required_graphic_state & (~SPRITE_GRAPHIC_STATE_MASK_FLIPPED_H)) | SPRITE_GRAPHIC_STATE_FLIPPED_RIGHT;
		}
		else
		{
			if(!(nframes & 7)) sprite_next_frame(&(p_isometric_obj_player->sprite));
		}
	}

	if(keyboard_is_key_pressed_2()) 
	{
		if(p_isometric_obj_player->physics.flags & PHYS_BOX3D_FLAG_TOUCH_D)
		{
			p_isometric_obj_player->physics.speed_x = p_isometric_obj_player->physics.p_phys_obj_touching_d->speed_x + 1;
		}

		if(ghost_last_orientation != (ISOMETRIC_ORIENTATION_S | ISOMETRIC_ORIENTATION_W))
		{
			ghost_last_orientation = ISOMETRIC_ORIENTATION_S | ISOMETRIC_ORIENTATION_W;
			sprite_set_frames_subset(&(p_isometric_obj_player->sprite), &spr_graph_def_ghost, 0, spr_graph_def_ghost.frame_size + spr_graph_def_ghost.frame_size);
			p_isometric_obj_player->sprite.required_graphic_state = (p_isometric_obj_player->sprite.required_graphic_state & (~SPRITE_GRAPHIC_STATE_MASK_FLIPPED_H)) | SPRITE_GRAPHIC_STATE_FLIPPED_LEFT;
		}
		else
		{
			if(!(nframes & 7)) sprite_next_frame(&(p_isometric_obj_player->sprite));
		}
	}

	if(keyboard_is_key_pressed_4()) 
	{
		if(p_isometric_obj_player->physics.flags & PHYS_BOX3D_FLAG_TOUCH_D)
		{
			predivisor_gravity = 0;
			p_isometric_obj_player->physics.speed_z = 4;
		}

		if(!(nframes & 7)) sprite_next_frame(&(p_isometric_obj_player->sprite));
	}

	if(keyboard_is_key_pressed_5()) 
	{
		if(!(nframes & 7)) sprite_next_frame(&(p_isometric_obj_player->sprite));
	}
}

void behavior_cinematic_updown(t_isometric_obj *p_isometric_obj)
{
	static int8 speedz = -1;
	static byte delay = 0;

	if(speedz < 0)
	{
		if(p_isometric_obj->physics.flags & PHYS_BOX3D_FLAG_TOUCH_D)
		{
			p_isometric_obj->physics.speed_z = 0;
		}
		else if(p_isometric_obj->physics.box3d.pos_z <= 10)
		{
			p_isometric_obj->physics.speed_z = speedz = 0;
			delay = 32;
		}
		else
		{
			p_isometric_obj->physics.speed_z = speedz;
		}
	}
	else if(speedz > 0)
	{
		if((p_isometric_obj->physics.flags & PHYS_BOX3D_FLAG_TOUCH_U) && (p_isometric_obj->physics.p_phys_obj_touching_u->flags & PHYS_BOX3D_FLAG_TOUCH_U ))
		{
			p_isometric_obj->physics.speed_z = 0;
		}
		else if(p_isometric_obj->physics.box3d.pos_z >= 20)
		{
			p_isometric_obj->physics.speed_z = speedz = 0;
			delay = 32;
		}
		else
		{
			p_isometric_obj->physics.speed_z = speedz;
		}
	}
	else
	{
		if(!(delay--))
		{
			if(p_isometric_obj->physics.box3d.pos_z >= 20)
				p_isometric_obj->physics.speed_z = speedz = -1;
			else
				p_isometric_obj->physics.speed_z = speedz = 1;
		}
		else
			p_isometric_obj->physics.speed_z = 0;
	}

}

/*******************************************************************************************************/

extern t_isometric_obj isometric_objects_table[];

void main()
{
	byte i;

	sprite_init();
	sprite_transfer_vdisplay();

	isometric_reset_table();
	isometric_add_object_to_table(&isometric_def_block, &pos_block_2, PHYS_BOX3D_FLAG_CINEMATIC, behavior_cinematic_updown);
	isometric_add_object_to_table(&isometric_def_block, &pos_block_0, 0, NULL);
	isometric_add_object_to_table(&isometric_def_block, &pos_block_1, 0, NULL);
	isometric_add_object_to_table(&isometric_def_ghost, &pos_ghost, 0, behavior_controller_player);

	// En estos momentos (18-09-2023) se observa aprox con 10 sprites en el bucle while(1)
	// 256 refrescos en 22 segundos =>
	// cada refresco de 10 sprites completos 86 ms, 8.6ms por sprite
	// 11.6 cuadros por segundo

	nframes = 0;
	while(1)//for(nframes = 256; nframes>=0; nframes--)
	{
		nframes++;

		keyboard_readrow_54321();
		keyboard_readrow_trewq();

		if(keyboard_is_key_pressed_t()) break;

		isometric_step();
	}

}

